<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Unregistered Subjects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; max-width: 960px; margin: 16px auto; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin: 12px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <div id="navbar"></div>

  <h1>รายวิชาที่ยังไม่ได้ลงทะเบียน</h1>
  <div id="meta" class="card">กำลังโหลดข้อมูลนักเรียน...</div>

  <div class="card">
    <table>
      <thead>
        <tr><th>ภาคการศึกษา</th><th>รหัสวิชา</th><th>ชื่อวิชา</th><th>หน่วยกิต</th></tr>
      </thead>
      <tbody id="unreg-body"><tr><td colspan="4" class="muted">กำลังโหลด...</td></tr></tbody>
    </table>
  </div>

  <script>
    async function loadNavbar() {
      const res = await fetch('/client/components/navbar.html');
      const html = await res.text();
      const container = document.getElementById('navbar');
      container.innerHTML = html;

      // ✅ สำคัญ: รัน <script> ภายใน navbar.html ที่ถูกแทรกเข้ามา
      const scripts = container.querySelectorAll('script');
      scripts.forEach(old => {
        const s = document.createElement('script');
        if (old.src) {
          s.src = old.src;
        } else {
          s.textContent = old.textContent;
        }
        document.body.appendChild(s);
        old.remove();
      });
    }

    loadNavbar()

    const me = (()=>{ try{return JSON.parse(localStorage.getItem('currentUser'))}catch{return null} })();
    if(!me){ location.href='/client/login.html' }

    async function loadUnregistered() {
      const meta = document.getElementById('meta');
      const body = document.getElementById('unreg-body');
      try {
        const headers = {
          'X-User-ID': me.user_id,
          'X-User-Type': me.user_type
        };

        const uRes    = await fetch('http://127.0.0.1:5000/me/profile', { credentials: 'include', headers });
        const listRes = await fetch('http://127.0.0.1:5000/me/unregistered-subjects', { credentials: 'include', headers });

        if(!uRes.ok) throw new Error('โหลดข้อมูลนักเรียนไม่สำเร็จ');
        if(!listRes.ok) throw new Error('โหลดรายการวิชาไม่สำเร็จ');

        const user = await uRes.json();
        const rows = await listRes.json();

        meta.innerHTML = `
          <div><strong>รหัสนักศึกษา:</strong> ${user.StudentID}</div>
          <div><strong>หลักสูตร:</strong> ${user.CurriculumID ?? '-'} ${user.CurriculumName? '('+user.CurriculumName+')':''}</div>
        `;

        body.innerHTML = rows.length
          ? rows.map(x => `
              <tr>
                <td>${x.Semester ?? '-'}</td>
                <td>${x.SubjectID}</td>
                <td>${x.SubjectName}</td>
                <td>${x.Credits}</td>
              </tr>
            `).join('')
          : `<tr><td colspan="4" class="muted">ครบแล้ว ไม่มีวิชาที่ยังไม่ลงทะเบียน</td></tr>`;
      } catch (e) {
        meta.textContent = e.message;
        body.innerHTML = `<tr><td colspan="4">โหลดไม่สำเร็จ</td></tr>`;
      }
    }
    loadUnregistered();
  </script>



</body>
</html>
