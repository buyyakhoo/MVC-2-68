<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Student Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; max-width: 960px; margin: 16px auto; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin: 12px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    .muted { color:#666; }
  </style>
</head>
<body>
    <div id="navbar"></div>

    <h1>ประวัตินักเรียน</h1>
    <div id="who" class="card">กำลังโหลดข้อมูล...</div>

    <h2>รายวิชาที่ได้รับเกรดแล้ว</h2>
    <div class="card">
        <table>
            <thead>
                <tr><th>รหัสวิชา</th><th>ชื่อวิชา</th><th>หน่วยกิต</th><th>เกรด</th></tr>
            </thead>
            <tbody id="graded-body"><tr><td colspan="4" class="muted">กำลังโหลด...</td></tr></tbody>
        </table>
    </div>

    <script>
        async function loadNavbar() {
            const res = await fetch('/client/components/navbar.html');
            const html = await res.text();
            const container = document.getElementById('navbar');
            container.innerHTML = html;
            const scripts = container.querySelectorAll('script');
            scripts.forEach(old => {
            const s = document.createElement('script');
            if (old.src) s.src = old.src; else s.textContent = old.textContent;
            document.body.appendChild(s); old.remove();
            });
        }
        loadNavbar();

        const me = (()=>{ try{return JSON.parse(localStorage.getItem('currentUser'))}catch{return null} })();
        if(!me){ location.href='/client/login.html' }

        const headers = { 'X-User-ID': me.user_id, 'X-User-Type': me.user_type };
        const params = new URLSearchParams(location.search);
        const qid = params.get('student_id');           // ถ้ามาจากหน้า Students จะมีค่า

        async function loadProfile() {
            const whoBox = document.getElementById('who');
            const tb = document.getElementById('graded-body');

            try {
            // เคส ADMIN + มี student_id -> ใช้ /students/<id>
            if (me.user_type === 'admin') {
                if (!qid) {
                    whoBox.innerHTML = '<span style="color:#b00">สำหรับผู้ดูแลระบบ: โปรดเปิดหน้านี้จาก Students หรือระบุ ?student_id=...</span>';
                    tb.innerHTML = `<tr><td colspan="4" class="muted">—</td></tr>`;
                    return;
                }

                const res = await fetch(`http://127.0.0.1:5000/students/${encodeURIComponent(qid)}`, {
                    credentials: 'include',
                    headers
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'โหลดข้อมูลนักเรียนไม่สำเร็จ');

                // แสดงข้อมูลนักเรียน
                whoBox.innerHTML = `
                <div><strong>รหัสนักศึกษา:</strong> ${data.StudentID}</div>
                <div><strong>ชื่อ-สกุล:</strong> ${[data.Title, data.FirstName, data.LastName].filter(Boolean).join(' ')}</div>
                <div><strong>หลักสูตร:</strong> ${data.CurriculumID ?? '-'} (${data.GPA !== undefined ? 'GPA: ' + data.GPA : ''})</div>
                `;

                // ใช้ RegisteredSubjects ที่ backend ส่งมาแล้ว
                const graded = (data.RegisteredSubjects || []).filter(r => r.Grade && r.Grade !== '');
                tb.innerHTML = graded.length
                ? graded.map(r => `
                    <tr>
                        <td>${r.SubjectID}</td>
                        <td>${r.SubjectName}</td>
                        <td>${r.Credits}</td>
                        <td>${r.Grade}</td>
                    </tr>
                    `).join('')
                : `<tr><td colspan="4" class="muted">ยังไม่มีรายวิชาที่ได้รับเกรด</td></tr>`;
                return;
            }

            // เคส STUDENT -> ใช้ /me/*
            const [uRes, regRes] = await Promise.all([
                fetch('http://127.0.0.1:5000/me/profile', { credentials: 'include', headers }),
                fetch('http://127.0.0.1:5000/me/registered-subjects', { credentials: 'include', headers })
            ]);
            if (!uRes.ok) {
                const err = await uRes.json().catch(()=> ({}));
                throw new Error(err.error || 'โหลดข้อมูลนักเรียนไม่สำเร็จ');
            }
            if (!regRes.ok) {
                const err = await regRes.json().catch(()=> ({}));
                throw new Error(err.error || 'โหลดรายวิชาไม่สำเร็จ');
            }

            const user = await uRes.json();
            const regs = await regRes.json();

            whoBox.innerHTML = `
                <div><strong>รหัสนักศึกษา:</strong> ${user.StudentID}</div>
                <div><strong>ชื่อ-สกุล:</strong> ${[user.Title, user.FirstName, user.LastName].filter(Boolean).join(' ')}</div>
                <div><strong>หลักสูตร:</strong> ${user.CurriculumID ?? '-'} ${user.CurriculumName? '('+user.CurriculumName+')':''}</div>
            `;

            const graded = regs.filter(r => r.Grade && r.Grade !== '');
            tb.innerHTML = graded.length
                ? graded.map(r => `
                    <tr>
                    <td>${r.SubjectID}</td>
                    <td>${r.SubjectName}</td>
                    <td>${r.Credits}</td>
                    <td>${r.Grade}</td>
                    </tr>
                `).join('')
                : `<tr><td colspan="4" class="muted">ยังไม่มีรายวิชาที่ได้รับเกรด</td></tr>`;
            } catch (e) {
            whoBox.textContent = e.message || 'เกิดข้อผิดพลาด';
            tb.innerHTML = `<tr><td colspan="4" class="muted">โหลดไม่สำเร็จ</td></tr>`;
            }
        }

        loadProfile();
    </script>




</body>
</html>
